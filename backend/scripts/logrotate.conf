# RAG Platform Logrotate Configuration
# Task 4.2: 기본 모니터링 로그 설정
#
# 설치 방법:
#   sudo cp backend/scripts/logrotate.conf /etc/logrotate.d/rag-platform
#   sudo chown root:root /etc/logrotate.d/rag-platform
#   sudo chmod 644 /etc/logrotate.d/rag-platform
#
# 테스트:
#   sudo logrotate -d /etc/logrotate.d/rag-platform  # Dry-run
#   sudo logrotate -f /etc/logrotate.d/rag-platform  # Force rotation
#
# 로그 확인:
#   sudo cat /var/lib/logrotate/status  # 마지막 로테이션 시간

# 일반 애플리케이션 로그 (90일 보관)
/var/log/rag-platform/app.log {
    # 로테이션 주기
    daily                    # 매일 로테이션
    rotate 90                # 90개 백업 유지 (90일)

    # 파일 관리
    missingok                # 파일이 없어도 에러 없이 계속
    notifempty               # 빈 파일은 로테이션하지 않음
    compress                 # 백업 파일 압축 (gzip)
    delaycompress            # 최신 백업은 압축하지 않음 (다음 로테이션 때 압축)

    # 권한 및 소유자
    create 0644 www-data www-data  # 새 파일 생성 시 권한 및 소유자

    # 날짜 기반 백업 파일명
    dateext                  # 백업 파일명에 날짜 추가 (app.log-20250111)
    dateformat -%Y%m%d       # 날짜 포맷: YYYYMMDD

    # 후처리 스크립트
    postrotate
        # FastAPI 프로세스에 SIGHUP 전송 (로그 파일 재오픈)
        # systemd 사용 시
        if [ -f /var/run/rag-platform.pid ]; then
            kill -HUP $(cat /var/run/rag-platform.pid) 2>/dev/null || true
        fi

        # Docker 컨테이너 사용 시
        # docker exec rag-backend kill -HUP 1 2>/dev/null || true
    endscript
}

# 에러 로그 (365일 보관)
/var/log/rag-platform/error.log {
    # 로테이션 주기
    daily                    # 매일 로테이션
    rotate 365               # 365개 백업 유지 (1년)

    # 파일 관리
    missingok
    notifempty
    compress
    delaycompress

    # 권한 및 소유자
    create 0644 www-data www-data

    # 날짜 기반 백업 파일명
    dateext
    dateformat -%Y%m%d

    # 후처리 스크립트
    postrotate
        if [ -f /var/run/rag-platform.pid ]; then
            kill -HUP $(cat /var/run/rag-platform.pid) 2>/dev/null || true
        fi
    endscript
}

# 스케줄러 로그 (90일 보관)
/var/log/rag-platform/scheduler.log {
    daily
    rotate 90
    missingok
    notifempty
    compress
    delaycompress
    create 0644 www-data www-data
    dateext
    dateformat -%Y%m%d

    postrotate
        if [ -f /var/run/rag-platform.pid ]; then
            kill -HUP $(cat /var/run/rag-platform.pid) 2>/dev/null || true
        fi
    endscript
}

# 주의사항:
# 1. www-data는 웹 서버 사용자 (nginx, apache 등)
#    실제 사용자로 변경 필요 (예: rag-user)
#
# 2. systemd 사용 시 PID 파일 경로 확인:
#    /var/run/rag-platform.pid
#    또는 /run/rag-platform/rag-platform.pid
#
# 3. Docker 사용 시 postrotate 스크립트 수정:
#    docker exec rag-backend kill -HUP 1
#
# 4. 압축 포맷 변경 (선택):
#    compresscmd /usr/bin/bzip2  # bzip2 사용
#    compressext .bz2
#
# 5. 크기 기반 로테이션 (일일 대신):
#    size 100M  # 100MB 초과 시 로테이션
#    # daily 제거
